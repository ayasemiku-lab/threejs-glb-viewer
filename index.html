<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>3モデル ギャラリー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Import Map のポリフィル（スマホ対応） -->
  <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>

  <!-- Import Map -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.165.0/build/three.module.js"
    }
  }
  </script>

  <style>
    body { margin:0; font:14px/1.5 system-ui, sans-serif; background:#0e0e10; color:#ddd; }
    h1 { text-align:center; padding:20px 0; }

    .gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 40px;
    }
    glb-viewer {
      aspect-ratio: 16/9;
      min-height: 220px;
      display: block;
      border-radius: 12px;
      overflow: hidden;
      background: #0e0e10;
      cursor: pointer;
    }

    /* モーダル */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      background: rgba(0,0,0,.6);
      backdrop-filter: blur(6px);
      padding: 0;
      z-index: 9999;
    }
    .modal.open { display: grid; }

    .modal__inner {
      position: relative;
      width: 100svw;
      height: 100svh;
    }
    @media (min-width: 900px) and (min-height: 700px) {
      .modal__inner {
        width: min(1200px, 96svw);
        height: min(90svh, 70svw);
        border: 1px solid rgba(255,255,255,.12);
        border-radius: 14px;
        box-shadow: 0 20px 60px rgba(0,0,0,.5);
        overflow: hidden;
      }
    }
    @media (max-width: 899px), (max-height: 699px) {
      .modal__inner {
        border: none;
        border-radius: 0;
      }
    }

    /* 閉じるボタン */
    .modal__close {
      position: absolute;
      top: max(8px, env(safe-area-inset-top));
      right: max(8px, env(safe-area-inset-right));
      border: 0;
      border-radius: 10px;
      background: rgba(255,255,255,.12);
      color: #fff;
      padding: 10px 12px;
      cursor: pointer;
    }
    .modal__close:hover { background: rgba(255,255,255,.2); }

    /* 戻るボタン（左上常時表示） */
    .modal__back {
      position: absolute;
      top: max(8px, env(safe-area-inset-top));
      left: max(8px, env(safe-area-inset-left));
      border: 0;
      border-radius: 10px;
      background: rgba(255,255,255,.12);
      color: #fff;
      padding: 10px 14px;
      cursor: pointer;
    }
    .modal__back:hover { background: rgba(255,255,255,.2); }

    #modalViewer {
      position: absolute;
      inset: 0;
      display: block;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <h1>GLB モデルギャラリー</h1>

  <main class="gallery">
    <glb-viewer src="assets/model.glb" autorotate></glb-viewer>
    <glb-viewer src="assets/model.glb" exposure="1.2"></glb-viewer>
    <glb-viewer src="assets/model.glb"></glb-viewer>
  </main>

  <!-- モーダル -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal__inner" role="dialog" aria-modal="true" aria-label="3D Viewer">
      <button class="modal__back" id="backBtn" aria-label="戻る">← 戻る</button>
      <button class="modal__close" id="closeBtn" aria-label="閉じる (Esc)">✕</button>
      <glb-viewer id="modalViewer" bg="#0e0e10" autorotate></glb-viewer>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://unpkg.com/three@0.165.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.165.0/examples/jsm/loaders/GLTFLoader.js';

    class GlbViewer extends HTMLElement {
      static get observedAttributes() { return ['src','autorotate','exposure','bg']; }
      constructor(){
        super();
        this.attachShadow({mode:'open'});
        const style=document.createElement('style');
        style.textContent=`:host{display:block;contain:content;}
          canvas{display:block;width:100%;height:100%}`;
        this.shadowRoot.append(style);

        this.renderer=new THREE.WebGLRenderer({antialias:true});
        this.renderer.setPixelRatio(Math.min(devicePixelRatio,2));
        this.renderer.outputColorSpace=THREE.SRGBColorSpace;
        this.shadowRoot.append(this.renderer.domElement);

        this.scene=new THREE.Scene();
        this.camera=new THREE.PerspectiveCamera(45,1,0.1,2000);
        this.camera.position.set(2.5,1.6,3.5);

        this.controls=new OrbitControls(this.camera,this.renderer.domElement);
        this.controls.enableDamping=true;

        this.scene.add(new THREE.HemisphereLight(0xffffff,0x222233,1.0));
        this.scene.add(new THREE.AmbientLight(0xffffff,0.6));

        this.loader=new GLTFLoader();
        this.clock=new THREE.Clock();

        this._resizeObserver = new ResizeObserver(()=>this._resize());
        this._resizeObserver.observe(this);

        window.addEventListener('resize', ()=>this._resize(), { passive:true });
        window.addEventListener('orientationchange', ()=>this._resize(), { passive:true });
      }
      connectedCallback(){ this._resize(); this._render(); if(this.getAttribute('src')) this._load(this.getAttribute('src')); }
      attributeChangedCallback(n,o,v){
        if(n==='src'&&v) this._load(v);
        if(n==='autorotate') this.controls.autoRotate=this.hasAttribute('autorotate');
        if(n==='exposure') this.renderer.toneMappingExposure=parseFloat(v)||1.0;
        if(n==='bg') this.scene.background=new THREE.Color(v);
      }
      _load(url){
        this.loader.load(url,(gltf)=>{
          if(this._root) this.scene.remove(this._root);
          this._root=gltf.scene;
          this.scene.add(this._root);
          this.refit();
        });
      }
      _resize(){
        const rect=this.getBoundingClientRect();
        const w=Math.max(1,Math.floor(rect.width));
        const h=Math.max(1,Math.floor(rect.height||this.offsetHeight||220));
        this.renderer.setSize(w,h,false);
        this.camera.aspect=w/h;
        this.camera.updateProjectionMatrix();
      }
      _render(){
        this.controls.update();
        this.renderer.render(this.scene,this.camera);
        requestAnimationFrame(()=>this._render());
      }
      refit(){
        if(!this._root){ this._resize(); return; }
        this._resize();
        const b=new THREE.Box3().setFromObject(this._root);
        const c=new THREE.Vector3(), s=new THREE.Vector3();
        b.getCenter(c); b.getSize(s);
        const maxDim=Math.max(s.x,s.y,s.z)||1.0;
        const fov=this.camera.fov*Math.PI/180;
        const dist=Math.abs(maxDim/2/Math.tan(fov/2));
        this.camera.position.set(c.x+dist*0.6, c.y+dist*0.6, c.z+dist*1.2);
        this.controls.target.copy(c);
        this.controls.update();
      }
    }
    customElements.define('glb-viewer',GlbViewer);

    // ===== モーダル制御 =====
    const modal=document.getElementById('modal');
    const modalV=document.getElementById('modalViewer');
    const closeBtn=document.getElementById('closeBtn');
    const backBtn=document.getElementById('backBtn');
    let lastFocusEl=null;

    function openModal(origin){
      lastFocusEl=origin;
      document.body.style.overflow='hidden';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      closeBtn.focus();
      requestAnimationFrame(()=>{ modalV.refit?.(); requestAnimationFrame(()=>modalV.refit?.()); });
    }
    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow='';
      if(lastFocusEl) lastFocusEl.focus();
    }

    closeBtn.addEventListener('click', closeModal);
    backBtn.addEventListener('click', closeModal);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

    document.querySelectorAll('.gallery glb-viewer').forEach(el=>{
      el.addEventListener('click', ()=>{ modalV.setAttribute('src', el.getAttribute('src')); openModal(el); });
    });

    window.addEventListener('resize', ()=> modal.classList.contains('open') && modalV.refit?.(), {passive:true});
    window.addEventListener('orientationchange', ()=> modal.classList.contains('open') && modalV.refit?.(), {passive:true});
  </script>
</body>
</html>
